#include "glasses.hpp"

void webSocketEvent(WStype_t type, uint8_t * payload, size_t length) {
    vector<string> message_parts = split((char*)payload, "Â¬");
    switch(type) {
		case WStype_DISCONNECTED:
			Serial.println("[WSc] Disconnected!\n");
			break;

		case WStype_CONNECTED:
			Serial.println("\n[WSc] Connected to url: /ws");
            client.sendTXT(AUTH_KEY);
            //delay(5000);
            Serial.println("Recording");
            micTask();
			break;

		case WStype_TEXT:
            if(message_parts[1] == AUTH_KEY){
                if(message_parts[0] == "start_recording"){
                    break;
                }
                else if(message_parts[0] == "get_recording"){
                    break;
                }
                else if(message_parts[0] == "take_picture"){
                    take_picture();
                    break;
                }
                else if(message_parts[0] == "volume"){
                    volume = stoi(message_parts[2]);
                    break;
                }
                else if(message_parts[0] == "play"){
                    // string to bytes -> play bytes
                    break;
                }
            }
			break;
            
		case WStype_BIN:
			break;
	}
}

void setup() {
    Serial.begin(115200);

    i2s_install();
    i2s_setpin();
    i2s_start(I2S_PORT);

    NeuralNetwork nn;

    audioBuffer = (int16_t*)malloc(TOTAL_SAMPLES * SAMPLE_SIZE);

    std::vector<double> waveform = {2, 0, 2, 0, 4, 0, 4, 0, 4, 0, 4, 0, 8, 0, 8, 0, 6, 0, 6, 0, 4, 0, 4, 0, 2, 0, 2, 0, 0, 0, 0, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 4, 0, 4, 0, 4, 0, 4, 0, 2, 0, 2, 0, 0, 0, 0, 0, 254, 255, 254, 255, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 2, 0, 2, 0, 4, 0, 4, 0, 2, 0, 2, 0, 254, 255, 254, 255, 0, 0, 0, 0, 2, 0, 2, 0, 254, 255, 254, 255, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 254, 255, 254, 255, 0, 0, 0, 0, 254, 255, 254, 255, 0, 0, 0, 0, 2, 0, 2, 0, 254, 255, 254, 255, 252, 255, 252, 255, 254, 255, 254, 255, 252, 255, 252, 255, 252, 255, 252, 255, 252, 255, 252, 255, 252, 255, 252, 255, 254, 255, 254, 255, 250, 255, 250, 255, 248, 255, 248, 255, 248, 255, 248, 255, 250, 255, 250, 255, 250, 255, 250, 255, 252, 255, 252, 255, 252, 255, 252, 255, 250, 255, 250, 255, 250, 255, 250, 255, 252, 255, 252, 255, 254, 255, 254, 255, 0, 0, 0, 0, 0, 0, 0, 0, 254, 255, 254, 255, 252, 255, 252, 255, 250, 255, 250, 255, 250, 255, 250, 255, 252, 255, 252, 255, 252, 255, 252, 255, 250, 255, 250, 255, 250, 255, 250, 255, 248, 255, 248, 255, 250, 255, 250, 255, 250, 255, 250, 255, 250, 255, 250, 255, 254, 255, 254, 255, 250, 255, 250, 255, 248, 255, 248, 255, 248, 255, 248, 255, 246, 255, 246, 255, 246, 255, 246, 255, 248, 255, 248, 255, 250, 255, 250, 255, 248, 255, 248, 255, 252, 255, 252, 255, 250, 255, 250, 255, 252, 255, 252, 255, 254, 255, 254, 255, 0, 0, 0, 0, 0, 0, 0, 0, 252, 255, 252, 255, 254, 255, 254, 255, 252, 255, 252, 255, 0, 0, 0, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 4, 0, 4, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 4, 0, 4, 0, 2, 0, 2, 0, 4, 0, 4, 0, 4, 0, 4, 0, 0, 0, 0, 0, 254, 255, 254, 255, 252, 255, 252, 255, 254, 255, 254, 255, 254, 255, 254, 255, 254, 255, 254, 255, 0, 0, 0, 0, 252, 255, 252, 255, 248, 255, 248, 255, 250, 255, 250, 255, 250, 255, 250, 255, 250, 255, 250, 255, 248, 255, 248, 255, 248, 255, 236, 255, 236, 255, 236, 255, 232, 255, 232, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 236, 255, 236, 255, 234, 255, 234, 255, 234, 255, 234, 255, 236, 255, 236, 255, 236, 255, 236, 255, 234, 255, 234, 255, 238, 255, 238, 255, 234, 255, 234, 255, 234, 255, 234, 255, 238, 255, 238, 255, 234, 255, 234, 255, 234, 255, 234, 255, 236, 255, 236, 255, 234, 255, 234, 255, 236, 255, 236, 255, 234, 255, 234, 255, 232, 255, 232, 255, 234, 255, 234, 255, 228, 255, 228, 255, 228, 255, 228, 255, 230, 255, 230, 255, 230, 255, 230, 255, 232, 255, 232, 255, 230, 255, 230, 255, 226, 255, 226, 255, 228, 255, 228, 255, 230, 255, 230, 255, 228, 255, 228, 255, 228, 255, 228, 255, 228, 255, 228, 255, 226, 255, 226, 255, 230, 255, 230, 255, 232, 255, 232, 255, 230, 255, 230, 255, 232, 255, 232, 255, 230, 255, 230, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 232, 255, 232, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 236, 255, 236, 255, 236, 255, 236, 255, 234, 255, 234, 255, 236, 255, 236, 255, 238, 255, 238, 255, 236, 255, 236, 255, 238, 255, 238, 255, 236, 255, 236, 255, 238, 255, 238, 255, 238, 255, 238, 255, 238, 255, 238, 255, 234, 255, 234, 255, 236, 255, 236, 255, 234, 255, 234, 255, 232, 255, 232, 255, 236, 255, 236, 255, 232, 255, 232, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 234, 255, 232, 255, 232, 255, 232, 255, 232, 255, 228, 255, 228, 255, 230, 255, 230, 255, 228, 255, 228, 255, 230, 255, 230, 255, 230, 255, 230, 255, 234, 255, 234, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 230, 255, 230, 255, 232, 255, 232, 255, 232, 255, 232, 255, 234, 255, 234, 255, 232, 255, 232, 255, 230, 255, 230, 255, 232, 255, 232, 255, 234, 255, 234, 255, 228, 255, 228, 255, 228, 255, 228, 255, 228, 255, 228, 255, 230, 255, 230, 255, 230, 255, 230, 255, 228, 255, 228, 255, 226, 255, 226, 255, 230, 255, 230, 255, 228, 255, 228, 255, 224, 255, 224, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 232, 255, 232, 255, 236, 255, 236, 255, 234, 255, 234, 255, 232, 255, 232, 255, 234, 255, 234, 255, 236, 255, 236, 255, 234, 255, 234, 255, 236, 255, 236, 255, 234, 255, 234, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 236, 255, 236, 255, 236, 255, 236, 255, 234, 255, 234, 255, 234, 255, 234, 255, 236, 255, 236, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 236, 255, 236, 255, 230, 255, 230, 255, 230, 255, 230, 255, 228, 255, 228, 255, 228, 255, 228, 255, 226, 255, 226, 255, 226, 255, 226, 255, 228, 255, 228, 255, 228, 255, 228, 255, 228, 255, 228, 255, 224, 255, 224, 255, 224, 255, 224, 255, 222, 255, 222, 255, 222, 255, 222, 255, 222, 255, 222, 255, 220, 255, 220, 255, 216, 255, 216, 255, 220, 255, 220, 255, 222, 255, 222, 255, 222, 255, 222, 255, 224, 255, 224, 255, 222, 255, 222, 255, 224, 255, 224, 255, 224, 255, 224, 255, 224, 255, 224, 255, 226, 255, 226, 255, 224, 255, 224, 255, 228, 255, 228, 255, 228, 255, 228, 255, 226, 255, 226, 255, 228, 255, 228, 255, 226, 255, 226, 255, 228, 255, 228, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 234, 255, 234, 255, 228, 255, 228, 255, 234, 255, 234, 255, 232, 255, 232, 255, 234, 255, 234, 255, 230, 255, 230, 255, 232, 255, 232, 255, 234, 255, 234, 255, 234, 255, 234, 255, 232, 255, 232, 255, 228, 255, 228, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 232, 255, 228, 255, 228, 255, 228, 255, 228, 255, 228, 255, 228, 255, 230, 255, 230, 255, 230, 255, 230, 255, 228, 255, 228, 255, 226, 255, 226, 255, 228, 255, 228, 255, 230, 255, 230, 255, 230, 255, 230, 255, 226, 255, 226, 255, 228, 255, 228, 255, 224, 255, 224, 255, 224, 255, 224, 255, 224, 255, 224, 255, 224, 255, 224, 255, 226, 255, 226, 255, 228, 255, 228, 255, 222, 255, 222, 255, 224, 255, 224, 255, 226, 255, 226, 255, 220, 255, 220, 255, 220, 255, 220, 255, 220, 255, 220, 255, 218, 255, 218, 255, 220, 255, 220, 255, 218, 255, 218, 255, 220, 255, 220, 255, 220, 255, 220, 255, 218, 255, 218, 255, 222, 255, 222, 255, 222, 255, 222, 255, 218, 255, 218, 255, 222, 255, 222, 255, 220, 255, 220, 255, 222, 255, 222, 255, 222, 255, 222, 255, 220, 255, 220, 255, 224, 255, 224, 255, 224, 255, 224, 255, 228, 255, 228, 255, 224, 255, 224, 255, 226, 255, 226, 255, 226, 255, 226, 255, 226, 255, 226, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 230, 255, 232, 255, 232, 255, 232, 255, 232, 255, 236, 255, 236, 255, 234, 255, 234, 255, 234, 255, 234, 255, 238, 255, 238, 255, 236, 255, 236, 255, 238, 255, 238, 255, 236, 255, 236, 255, 236, 255, 236, 255, 238, 255, 238, 255, 238, 255, 238, 255, 240, 255, 240, 255, 240, 255, 240, 255, 238, 255, 238, 255, 238, 255, 238, 255, 236, 255, 236, 255, 234, 255, 234, 255};
    
    int predicted_class_index = nn.predict(waveform);
    //Serial.println(predicted_class_index);

    //setup_camera();
    connect_wifi("3Pocket_66B9808B", "LWS36G3Hsx");

    client.begin("192.168.0.183", 4040, "/ws");
    client.onEvent(webSocketEvent);
    client.setReconnectInterval(5000);
}

void loop() {
    client.loop();
}